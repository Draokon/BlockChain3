<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <title>Aukcionas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 500px; margin: auto; border-radius: 15px; background: white; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); box-sizing: border-box; }
        #timerCorner { position: fixed; top: 20px; right: 20px; background: white; color: #f0b90b; padding: 20px; border-radius: 12px; font-size: 1.8em; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; border: 2px solid #f0b90b; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; font-size: 1em; box-sizing: border-box; display: block; }
        input { border: 1px solid #ddd; }
        button { border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-main { background: #f0b90b; color: black; }
        .btn-main:hover { background: #d8a60a; }
        .btn-withdraw { background: #4CAF50; color: white; margin-top: 20px; }
        .btn-withdraw:hover { background: #45a049; }
        .btn-finalize { background: #e91e63; color: white; }
        .btn-finalize:hover { background: #d81b60; }
        .btn-cancel { background: #6c757d; color: white; margin-top: 10px; }
        .btn-cancel:hover { background: #5a6268; }
        #historyList { background: #fafafa; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; font-size: 0.9em; border: 1px solid #eee; }
        .bid-item { padding: 5px; border-bottom: 1px solid #eee; }
        #status { color: blue; font-weight: bold; }
        #statusMessage { color: #d32f2f; text-align: center; font-weight: bold; margin-bottom: 10px; min-height: 1.2em; }
    </style>
</head>
<body>
<div class="container">
    <h2>Aukciono valdymas</h2>
    <div id="statusMessage"></div>
    
    <p>Statusas: <span id="status">Kraunama...</span></p>
    <p>DidÅ¾iausias statymas: <span id="highestBid">0</span> ETH</p>
    
    <hr>
    
    <input type="number" id="bidAmount" placeholder="Suma (ETH)" step="0.01">
    <button onclick="placeBid()">Atlikti statymÄ… (Bid)</button>
    
    <button class="btn-secondary" onclick="updateUI()">Atnaujinti duomenis</button>
    <button class="btn-withdraw" onclick="withdrawFunds()">Atsiimti pinigus (Seller/Outbid)</button>
    <button class="btn-finalize" onclick="finalizeAuction()">UÅ¾baigti aukcionÄ… (Finalize)</button>
    
    <div id="auctionHistory">
        <h4>StatymÅ³ istorija:</h4>
        <ul id="historyList"></ul>
    </div>
</div>

<script>
    const contractABI = [
        {"inputs":[{"internalType":"uint256","name":"_minBid","type":"uint256"},{"internalType":"uint256","name":"_duration","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},
        {"anonymous":false,"inputs":[],"name":"AuctionCancelled","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"AuctionFinalized","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BidPlaced","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"receiver","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Withdrawal","type":"event"},
        {"inputs":[],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},
        {"inputs":[],"name":"cancel","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"endTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"finalize","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"highestBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"highestBidder","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"minBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingReturns","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"seller","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"status","outputs":[{"internalType":"enum Auction.AuctionStatus","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}
    ];

    let contract;
    let signer;
    const contractBytecode = "60a060405234801561001057600080fd5b50604051611624380380611624833981810160405281019061003291906100ec565b3373ffffffffffffffffffffffffffffffffffffffff1660808173ffffffffffffffffffffffffffffffffffffffff1681525050816000819055508042610079919061015b565b6003819055506000600460006101000a81548160ff021916908360028111156100a5576100a461018f565b5b021790555050506101be565b600080fd5b6000819050919050565b6100c9816100b6565b81146100d457600080fd5b50565b6000815190506100e6816100c0565b92915050565b60008060408385031215610103576101026100b1565b5b6000610111858286016100d7565b9250506020610122858286016100d7565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610166826100b6565b9150610171836100b6565b92508282019050808211156101895761018861012c565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b60805161143d6101e760003960008181610231015281816109bc0152610ad4015261143d6000f3fe60806040526004361061009c5760003560e01c80633ccfd60b116100645780633ccfd60b146101695780633e109a19146101805780634bb278f3146101ab57806391f90157146101c2578063d57bde79146101ed578063ea8a1af0146102185761009c565b806308551a53146100a15780631998aeef146100cc578063200d2ed2146100d657806326b387bb146101015780633197cbb61461013e575b600080fd5b3480156100ad57600080fd5b506100b661022f565b6040516100c39190610d41565b60405180910390f35b6100d4610253565b005b3480156100e257600080fd5b506100eb610585565b6040516100f89190610dd3565b60405180910390f35b34801561010d57600080fd5b5061012860048036038101906101239190610e1f565b610598565b6040516101359190610e65565b60405180910390f35b34801561014a57600080fd5b506101536105b0565b6040516101609190610e65565b60405180910390f35b34801561017557600080fd5b5061017e6105b6565b005b34801561018c57600080fd5b50610195610806565b6040516101a29190610e65565b60405180910390f35b3480156101b757600080fd5b506101c061080c565b005b3480156101ce57600080fd5b506101d7610aa6565b6040516101e49190610d41565b60405180910390f35b3480156101f957600080fd5b50610202610acc565b60405161020f9190610e65565b60405180910390f35b34801561022457600080fd5b5061022d610ad2565b005b7f000000000000000000000000000000000000000000000000000000000000000081565b600660009054906101000a900460ff16156102a3576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161029a90610edd565b60405180910390fd5b6001600660006101000a81548160ff021916908315150217905550600060028111156102d2576102d1610d5c565b5b600460009054906101000a900460ff1660028111156102f4576102f3610d5c565b5b14610334576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161032b90610f49565b60405180910390fd5b6003544210610378576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161036f90610fb5565b60405180910390fd5b6000543410156103bd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103b490611021565b60405180910390fd5b6001543411610401576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103f89061108d565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff16600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146104d25760015460056000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546104ca91906110dc565b925050819055505b33600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550346001819055503373ffffffffffffffffffffffffffffffffffffffff167f3fabff0a9c3ecd6814702e247fa9733e5d0aa69e3a38590f92cb18f623a2254d346040516105609190610e65565b60405180910390a26000600660006101000a81548160ff021916908315150217905550565b600460009054906101000a900460ff1681565b60056020528060005260406000206000915090505481565b60035481565b600660009054906101000a900460ff1615610606576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105fd90610edd565b60405180910390fd5b6001600660006101000a81548160ff0219169083151502179055506000600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050600081116106a8576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161069f9061115c565b60405180910390fd5b6000600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555060003373ffffffffffffffffffffffffffffffffffffffff1682604051610713906111ad565b60006040518083038185875af1925050503d8060008114610750576040519150601f19603f3d011682016040523d82523d6000602084013e610755565b606091505b5050905080610799576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107909061120e565b60405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff167f7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65836040516107df9190610e65565b60405180910390a250506000600660006101000a81548160ff021916908315150217905550565b60005481565b600660009054906101000a900460ff161561085c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161085390610edd565b60405180910390fd5b6001600660006101000a81548160ff0219169083151502179055506003544210156108bc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108b39061127a565b60405180910390fd5b600060028111156108d0576108cf610d5c565b5b600460009054906101000a900460ff1660028111156108f2576108f1610d5c565b5b14610932576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610929906112e6565b60405180910390fd5b6001600460006101000a81548160ff0219169083600281111561095857610957610d5c565b5b0217905550600073ffffffffffffffffffffffffffffffffffffffff16600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610a2c57600154600560007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610a2491906110dc565b925050819055505b7f357afab190ee87fe0ef1c717f2728d2904d9e415a069d99f4d9382873cb3279d600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600154604051610a81929190611306565b60405180910390a16000600660006101000a81548160ff021916908315150217905550565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60015481565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610b60576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b579061137b565b60405180910390fd5b60006002811115610b7457610b73610d5c565b5b600460009054906101000a900460ff166002811115610b9657610b95610d5c565b5b14610bd6576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bcd906113e7565b60405180910390fd5b6002600460006101000a81548160ff02191690836002811115610bfc57610bfb610d5c565b5b0217905550600073ffffffffffffffffffffffffffffffffffffffff16600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610cd25760015460056000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610cca91906110dc565b925050819055505b7fa5fb31e47bd1eca58bf14a3312d5e6aeafdc4ee787c8ed348c15c2b092324d9360405160405180910390a1565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610d2b82610d00565b9050919050565b610d3b81610d20565b82525050565b6000602082019050610d566000830184610d32565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b60038110610d9c57610d9b610d5c565b5b50565b6000819050610dad82610d8b565b919050565b6000610dbd82610d9f565b9050919050565b610dcd81610db2565b82525050565b6000602082019050610de86000830184610dc4565b92915050565b600080fd5b610dfc81610d20565b8114610e0757600080fd5b50565b600081359050610e1981610df3565b92915050565b600060208284031215610e3557610e34610dee565b5b6000610e4384828501610e0a565b91505092915050565b6000819050919050565b610e5f81610e4c565b82525050565b6000602082019050610e7a6000830184610e56565b92915050565b600082825260208201905092915050565b7f4e6f2072652d656e7472616e6379000000000000000000000000000000000000600082015250565b6000610ec7600e83610e80565b9150610ed282610e91565b602082019050919050565b60006020820190508181036000830152610ef681610eba565b9050919050565b7f41756b63696f6e6173206e65616b747976757300000000000000000000000000600082015250565b6000610f33601383610e80565b9150610f3e82610efd565b602082019050919050565b60006020820190508181036000830152610f6281610f26565b9050919050565b7f41756b63696f6e61732070617369626169676573000000000000000000000000600082015250565b6000610f9f601483610e80565b9150610faa82610f69565b602082019050919050565b60006020820190508181036000830152610fce81610f92565b9050919050565b7f506572206d617a61732070726164696e69732073746174796d61730000000000600082015250565b600061100b601b83610e80565b915061101682610fd5565b602082019050919050565b6000602082019050818103600083015261103a81610ffe565b9050919050565b7f4a6175207972612064696465736e69732073746174796d617300000000000000600082015250565b6000611077601983610e80565b915061108282611041565b602082019050919050565b600060208201905081810360008301526110a68161106a565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006110e782610e4c565b91506110f283610e4c565b925082820190508082111561110a576111096110ad565b5b92915050565b7f4e65747572697465206c6573752061747369656d696d75690000000000000000600082015250565b6000611146601883610e80565b915061115182611110565b602082019050919050565b6000602082019050818103600083015261117581611139565b9050919050565b600081905092915050565b50565b600061119760008361117c565b91506111a282611187565b600082019050919050565b60006111b88261118a565b9150819050919050565b7f506572766564696d6173206e65706176796b6f00000000000000000000000000600082015250565b60006111f8601383610e80565b9150611203826111c2565b602082019050919050565b60006020820190508181036000830152611227816111eb565b9050919050565b7f41756b63696f6e617320646172206e6573696261696765000000000000000000600082015250565b6000611264601783610e80565b915061126f8261122e565b602082019050919050565b6000602082019050818103600083015261129381611257565b9050919050565b7f41756b63696f6e6173206a617520757a62616967746173000000000000000000600082015250565b60006112d0601783610e80565b91506112db8261129a565b602082019050919050565b600060208201905081810360008301526112ff816112c3565b9050919050565b600060408201905061131b6000830185610d32565b6113286020830184610e56565b9392505050565b7f54696b20706172646176656a61732067616c692061747361756b746900000000600082015250565b6000611365601c83610e80565b91506113708261132f565b602082019050919050565b6000602082019050818103600083015261139481611358565b9050919050565b7f4e6567616c696d612061747361756b7469000000000000000000000000000000600082015250565b60006113d1601183610e80565b91506113dc8261139b565b602082019050919050565b60006020820190508181036000830152611400816113c4565b905091905056fea2646970667358221220622d78be96b7f326f2169a3a0f91c9528f5ed2d3cf604d4818eacb125e69130464736f6c634300081f0033"; 

    async function init() {
        if (window.ethereum) {
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                window.ethereum.on('accountsChanged', async (accounts) => {
            if (accounts.length > 0) {

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                if (contract) {
                    contract = contract.connect(signer);
                }
                
                console.log("Paskyra pasikeitÄ— Ä¯:", accounts[0]);
                setTimeout(() => {
                    updateUI();
                }, 500); 
            } else {
                window.location.reload();
            }
        });
    }
}

    async function deployNewAuction() {
        const minBid = document.getElementById("newMinBid").value;
        const duration = document.getElementById("newDuration").value;
        
        try {
            const factory = new ethers.ContractFactory(contractABI, contractBytecode, signer);
            const deployed = await factory.deploy(ethers.utils.parseEther(minBid), duration);
            await deployed.deployed();
            contract = deployed;

            document.getElementById("setupScreen").style.display = "none";
            document.getElementById("auctionScreen").style.display = "block";
            
            setupEventListeners();
            loadHistory(); 
            updateUI();
            startCountdown();
        } catch (e) { alert("Klaida: " + e.message); }
    }

    function setupEventListeners() {
        contract.on("BidPlaced", (bidder, amount) => {
            updateUI();
            addBidToUI(bidder, amount);
        });
    }

    async function loadHistory() {
        const filter = contract.filters.BidPlaced();
        const logs = await contract.queryFilter(filter);
        logs.forEach(log => addBidToUI(log.args.bidder, log.args.amount));
    }

    function addBidToUI(bidder, amount) {
        const list = document.getElementById("historyList");
        const div = document.createElement("div");
        div.className = "bid-item";
        div.innerHTML = `ðŸ‘¤ ${bidder.substring(0,6)}... â†’ ðŸ’° <b>${ethers.utils.formatEther(amount)} ETH</b>`;
        list.prepend(div);
    }
        
    async function updateUI() {
        if (!contract|| !signer) return;
        try {
        // Tikriname ar pagrindiniai elementai egzistuoja
        const hbElement = document.getElementById("highestBid");
        const statusElement = document.getElementById("status");
        if (!hbElement || !statusElement) return; 

        const hb = await contract.highestBid();
        const bidder = await contract.highestBidder(); // PridÄ—ta!
        const status = await contract.status();
        if (status === 2) { // 2 reiÅ¡kia Cancelled (pagal Enum eilÄ™)
            document.getElementById("statusMessage").innerText = "AUKCIONAS ATÅ AUKTAS!";
            document.getElementById("bidButton").disabled = true;
        }
        const sellerAddress = await contract.seller();
        const myAddress = await signer.getAddress();


        hbElement.innerText = ethers.utils.formatEther(hb);
        
        // Atvaizduojame laimÄ—tojÄ…
        document.getElementById("highestBidder").innerText = 
            bidder === ethers.constants.AddressZero ? "NÄ—ra" : bidder.substring(0, 8) + "...";

        const statusai = ["Aktyvus", "UÅ¾baigtas", "AtÅ¡auktas"];
        statusElement.innerText = statusai[status];

        const finalizeBtn = document.querySelector(".btn-finalize");
        
        if (myAddress.toLowerCase() === sellerAddress.toLowerCase()) {
            finalizeBtn.style.display = "block";
            const endTime = await contract.endTime();
            const now = Math.floor(Date.now() / 1000);
            
            // LeidÅ¾iame spausti tik jei laikas baigÄ—si
            finalizeBtn.disabled = (now < endTime.toNumber() || status !== 0);
        } else {
            finalizeBtn.style.display = "none";
        }
    } catch (e) {
        console.error("UI atnaujinimo klaida:", e);
    }
        
    }

    function startCountdown() {
        window.auctionInterval = setInterval(async () => {
            const endTime = await contract.endTime();
            const now = Math.floor(Date.now() / 1000);
            const diff = endTime.toNumber() - now;
            const timerEl = document.getElementById("timerCorner");

            if (diff <= 0) {
                timerEl.innerText = "00:00";
                timerEl.style.color = "#ff4444";
                document.getElementById("statusMessage").innerText = "AUKCIONAS PASIBAIGÄ–!";
            } else {
                const m = Math.floor(diff / 60);
                const s = diff % 60;
                timerEl.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            }
        }, 1000);
    }

    async function placeBid() {
        const val = document.getElementById("bidAmount").value;
        try {
            const tx = await contract.bid({ value: ethers.utils.parseEther(val) });
            await tx.wait();
        } catch (e) { alert(e.data?.message || e.message); }
    }

    async function finalizeAuction() {
        try {
            const activeContract = contract.connect(signer);
            const tx = await activeContract.finalize({ gasLimit: 100000 }); 
            
            console.log("Transakcija iÅ¡siÅ³sta...");
            await tx.wait();
            alert("Aukcionas baigtas!");
            updateUI();
        } catch (e) {
            console.log("Visa klaida:", e);
            let reason = "NeÅ¾inoma klaida (patikrinkite laikÄ… arba adresÄ…)";
            if (e.data && e.data.message) reason = e.data.message;
            else if (e.message) reason = e.message;
            alert("Klaida: " + reason);
        }
    }

    async function withdrawFunds() {
        try {
            const tx = await contract.withdraw();
            await tx.wait();
            alert("Pinigai pervesti Ä¯ jÅ«sÅ³ piniginÄ™!");
        } catch (e) {
            alert("Klaida: " + (err.reason || "Neturite lÄ—Å¡Å³ atsiÄ—mimui."));
        }
    }

    async function cancelAuction() {
    if (!confirm("Ar tikrai norite atÅ¡aukti aukcionÄ…? Pinigai bus grÄ…Å¾inti.")) return;

    try {
        const activeContract = contract.connect(signer);
        const tx = await activeContract.cancel();
        await tx.wait();

        alert("Aukcionas atÅ¡auktas.");
        
        resetToSetup();
    } catch (e) {
        alert("Klaida: " + (e.data?.message || e.message));
    }
}

    function resetToSetup() {
        if (window.auctionInterval) clearInterval(window.auctionInterval);
  
        document.getElementById("auctionScreen").style.display = "none";
        document.getElementById("setupScreen").style.display = "block";

        document.getElementById("newMinBid").value = "";
        document.getElementById("newDuration").value = "";
        document.getElementById("timerCorner").innerText = "--:--";
        document.getElementById("statusMessage").innerText = "";

        contract = null;
    }

    window.onload = init;
</script>
</body>
</html>
